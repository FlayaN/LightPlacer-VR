#pragma once

template <>
struct glz::meta<RE::NiPoint3>
{
	using T = RE::NiPoint3;
	static constexpr auto value = array(&T::x, &T::y, &T::z);
};

namespace boost
{
	template <class T>
	struct hash<RE::NiPointer<T>>
	{
		std::size_t operator()(const RE::NiPointer<T>& ptr) const
		{
			return boost::hash<T*>()(ptr.get());
		}
	};
}

namespace RE
{
	inline bool IsActor(TESObjectREFR* a_ref)
	{
		return a_ref->Is(RE::FormType::ActorCharacter);
	}

	inline NiColor GetLightDiffuse(TESObjectLIGH* a_light)
	{
		auto diffuse = NiColor(a_light->data.color);
		return a_light->data.flags.any(TES_LIGHT_FLAGS::kNegative) ? -diffuse : diffuse;
	}

	template <class T>
	void AttachNode(RE::NiNode* a_root, T* a_obj)
	{
		if (RE::TaskQueueInterface::ShouldUseTaskQueue()) {
			RE::TaskQueueInterface::GetSingleton()->QueueNodeAttach(a_obj, a_root);
		} else {
			a_root->AttachChild(a_obj, true);
		}
	}

	inline std::string SanitizeModel(const std::string& a_path)
	{
		auto path = string::tolower(a_path);

		path = srell::regex_replace(path, srell::regex("/+|\\\\+"), "\\");
		path = srell::regex_replace(path, srell::regex("^\\\\+"), "");
		path = srell::regex_replace(path, srell::regex(R"(.*?[^\s]meshes\\|^meshes\\)", srell::regex::icase), "");

		return path;
	}

	inline FormID GetFormID(const std::string& a_str)
	{
		if (const auto splitID = string::split(a_str, "~"); splitID.size() == 2) {
			const auto  formID = string::to_num<FormID>(splitID[0], true);
			const auto& modName = splitID[1];
			if (g_mergeMapperInterface) {
				const auto [mergedModName, mergedFormID] = g_mergeMapperInterface->GetNewFormID(modName.c_str(), formID);
				return TESDataHandler::GetSingleton()->LookupFormID(mergedFormID, mergedModName);
			} else {
				return TESDataHandler::GetSingleton()->LookupFormID(formID, modName);
			}
		}
		if (string::is_only_hex(a_str, true)) {
			return string::to_num<RE::FormID>(a_str, true);
		}
		if (const auto form = RE::TESForm::LookupByEditorID(a_str)) {
			return form->GetFormID();
		}
		return static_cast<RE::FormID>(0);
	}

	template <class T>
	inline T* GetFormFromID(const std::string& a_str)
	{
		auto formID = GetFormID(a_str);
		return formID != 0 ? RE::TESForm::LookupByID<T>(GetFormID(a_str)) : nullptr;
	}

	inline float NiSinQImpl(float a_value)
	{
		static constexpr std::array<float, 512> sineTable = {
			0,
			0.012271538,
			0.024541229,
			0.036807224,
			0.049067676,
			0.06132074,
			0.07356457,
			0.08579731,
			0.098017134,
			0.1102222,
			0.12241066,
			0.1345807,
			0.14673047,
			0.15885815,
			0.1709619,
			0.1830399,
			0.19509034,
			0.2071114,
			0.21910127,
			0.23105815,
			0.24298023,
			0.2548657,
			0.2667128,
			0.27851975,
			0.29028472,
			0.302006,
			0.3136818,
			0.32531038,
			0.33688992,
			0.34841877,
			0.3598951,
			0.3713173,
			0.38268352,
			0.39399213,
			0.40524143,
			0.41642967,
			0.4275552,
			0.43861637,
			0.44961146,
			0.46053883,
			0.47139686,
			0.48218387,
			0.4928983,
			0.5035384,
			0.51410276,
			0.5245897,
			0.53499764,
			0.545325,
			0.5555702,
			0.56573176,
			0.5758081,
			0.5857978,
			0.5956992,
			0.6055109,
			0.61523145,
			0.62485933,
			0.6343931,
			0.6438313,
			0.6531726,
			0.6624155,
			0.6715587,
			0.6806007,
			0.68954027,
			0.69837594,
			0.7071065,
			0.7157305,
			0.72424674,
			0.7326539,
			0.74095076,
			0.74913603,
			0.75720847,
			0.7651669,
			0.7730101,
			0.7807368,
			0.788346,
			0.79583645,
			0.8032071,
			0.81045675,
			0.81758434,
			0.82458884,
			0.8314692,
			0.83822423,
			0.8448531,
			0.8513548,
			0.85772824,
			0.8639725,
			0.87008667,
			0.8760698,
			0.881921,
			0.88763934,
			0.89322406,
			0.89867425,
			0.9039891,
			0.90916777,
			0.9142096,
			0.91911376,
			0.9238794,
			0.928506,
			0.9329927,
			0.93733895,
			0.941544,
			0.9456073,
			0.94952816,
			0.953306,
			0.95694035,
			0.9604305,
			0.9637761,
			0.9669765,
			0.97003126,
			0.97293997,
			0.97570217,
			0.9783174,
			0.98078537,
			0.98310554,
			0.98527765,
			0.98730147,
			0.98917663,
			0.99090266,
			0.99247956,
			0.99390703,
			0.9951848,
			0.9963127,
			0.9972905,
			0.99811816,
			0.9987955,
			0.9993224,
			0.9996988,
			0.9999247,
			1,
			0.9999247,
			0.99969876,
			0.99932235,
			0.9987954,
			0.9981181,
			0.9972904,
			0.99631256,
			0.99518466,
			0.99390686,
			0.9924794,
			0.9909025,
			0.98917633,
			0.98730123,
			0.9852775,
			0.98310524,
			0.980785,
			0.97831714,
			0.9757018,
			0.97293967,
			0.9700309,
			0.96697617,
			0.96377563,
			0.9604301,
			0.9569399,
			0.9533056,
			0.9495276,
			0.94560677,
			0.94154346,
			0.9373384,
			0.93299216,
			0.9285054,
			0.9238788,
			0.9191131,
			0.914209,
			0.90916723,
			0.9039885,
			0.89867365,
			0.8932234,
			0.8876387,
			0.88192034,
			0.87606907,
			0.87008595,
			0.86397177,
			0.85772747,
			0.851354,
			0.8448523,
			0.83822346,
			0.83146834,
			0.824588,
			0.81758344,
			0.8104558,
			0.8032061,
			0.79583544,
			0.7883449,
			0.7807357,
			0.7730088,
			0.76516557,
			0.75720716,
			0.74913466,
			0.74094933,
			0.7326524,
			0.7242452,
			0.7157289,
			0.7071048,
			0.6983742,
			0.6895385,
			0.68059886,
			0.6715568,
			0.66241354,
			0.6531705,
			0.64382917,
			0.6343909,
			0.624857,
			0.61522907,
			0.6055085,
			0.5956967,
			0.5857952,
			0.5758055,
			0.565729,
			0.5555674,
			0.5453221,
			0.5349947,
			0.52458674,
			0.5140997,
			0.50353533,
			0.49289507,
			0.4821806,
			0.47139347,
			0.4605354,
			0.44960797,
			0.43861282,
			0.42755163,
			0.41642603,
			0.40523773,
			0.3939884,
			0.38267976,
			0.37131345,
			0.35989127,
			0.34841484,
			0.336886,
			0.32530636,
			0.31367776,
			0.30200192,
			0.2902806,
			0.27851558,
			0.26670858,
			0.25486144,
			0.2429759,
			0.2310538,
			0.21909688,
			0.20710696,
			0.19508587,
			0.18303539,
			0.17095734,
			0.15885356,
			0.14672585,
			0.13457604,
			0.12240596,
			0.11021745,
			0.09801234,
			0.085792474,
			0.07355969,
			0.061315827,
			0.04906273,
			0.03680224,
			0.024536205,
			0.012266479,
			-5.094213e-06,
			-0.012276667,
			-0.02454639,
			-0.036812417,
			-0.0490729,
			-0.061325993,
			-0.07356986,
			-0.08580263,
			-0.09802249,
			-0.110227585,
			-0.12241608,
			-0.13458614,
			-0.14673592,
			-0.15886362,
			-0.17096739,
			-0.18304542,
			-0.19509587,
			-0.20711695,
			-0.21910682,
			-0.23106371,
			-0.2429858,
			-0.2548713,
			-0.26671842,
			-0.27852535,
			-0.29029036,
			-0.30201164,
			-0.31368744,
			-0.325316,
			-0.33689559,
			-0.3484244,
			-0.35990077,
			-0.37132293,
			-0.38268918,
			-0.3939978,
			-0.40524706,
			-0.4164353,
			-0.42756084,
			-0.43862197,
			-0.44961706,
			-0.46054444,
			-0.47140247,
			-0.48218948,
			-0.4929039,
			-0.50354403,
			-0.5141084,
			-0.5245953,
			-0.53500324,
			-0.54533064,
			-0.55557585,
			-0.5657374,
			-0.5758138,
			-0.5858034,
			-0.59570485,
			-0.60551655,
			-0.61523706,
			-0.62486494,
			-0.6343987,
			-0.643837,
			-0.6531782,
			-0.6624211,
			-0.6715643,
			-0.68060625,
			-0.68954575,
			-0.6983814,
			-0.70711195,
			-0.715736,
			-0.72425216,
			-0.73265934,
			-0.7409561,
			-0.74914134,
			-0.7572138,
			-0.7651721,
			-0.77301526,
			-0.780742,
			-0.7883511,
			-0.7958416,
			-0.80321217,
			-0.81046176,
			-0.8175893,
			-0.8245937,
			-0.831474,
			-0.838229,
			-0.8448578,
			-0.85135937,
			-0.8577328,
			-0.86397696,
			-0.870091,
			-0.876074,
			-0.8819251,
			-0.8876434,
			-0.893228,
			-0.8986781,
			-0.9039929,
			-0.90917146,
			-0.9142132,
			-0.9191172,
			-0.92388284,
			-0.92850924,
			-0.9329959,
			-0.93734205,
			-0.941547,
			-0.94561017,
			-0.94953096,
			-0.9533087,
			-0.9569429,
			-0.960433,
			-0.9637785,
			-0.9669788,
			-0.9700334,
			-0.972942,
			-0.9757041,
			-0.9783193,
			-0.98078704,
			-0.9831072,
			-0.9852792,
			-0.9873029,
			-0.9891778,
			-0.99090385,
			-0.99248064,
			-0.99390805,
			-0.9951857,
			-0.99631345,
			-0.9972912,
			-0.99811864,
			-0.99879587,
			-0.9993227,
			-0.99969906,
			-0.99992484,
			-1,
			-0.99992466,
			-0.9996986,
			-0.999322,
			-0.998795,
			-0.9981175,
			-0.9972898,
			-0.9963118,
			-0.99518377,
			-0.9939059,
			-0.9924784,
			-0.9909013,
			-0.9891751,
			-0.98729986,
			-0.9852759,
			-0.9831037,
			-0.98078334,
			-0.97831535,
			-0.9756999,
			-0.9729376,
			-0.97002876,
			-0.9669739,
			-0.96377337,
			-0.9604277,
			-0.9569373,
			-0.9533029,
			-0.94952494,
			-0.94560397,
			-0.94154054,
			-0.9373354,
			-0.932989,
			-0.9285022,
			-0.9238755,
			-0.9191097,
			-0.91420543,
			-0.90916353,
			-0.9039847,
			-0.8986697,
			-0.8932195,
			-0.88763463,
			-0.88191617,
			-0.87606484,
			-0.8700816,
			-0.8639673,
			-0.85772294,
			-0.8513494,
			-0.8448476,
			-0.8382186,
			-0.8314634,
			-0.82458293,
			-0.8175783,
			-0.81045055,
			-0.8032008,
			-0.79583,
			-0.7883394,
			-0.78073007,
			-0.77300316,
			-0.76515985,
			-0.7572013,
			-0.7491287,
			-0.7409433,
			-0.73264635,
			-0.724239,
			-0.7157226,
			-0.7070985,
			-0.6983678,
			-0.689532,
			-0.6805923,
			-0.67155015,
			-0.6624068,
			-0.6531638,
			-0.6438224,
			-0.634384,
			-0.62485003,
			-0.61522204,
			-0.60550135,
			-0.59568954,
			-0.58578795,
			-0.57579815,
			-0.5657217,
			-0.55556,
			-0.5453146,
			-0.53498715,
			-0.5245791,
			-0.514092,
			-0.5035276,
			-0.4928873,
			-0.48217276,
			-0.47138563,
			-0.46052748,
			-0.4496,
			-0.4386048,
			-0.42754358,
			-0.41641793,
			-0.4052296,
			-0.39398023,
			-0.38267154,
			-0.3713052,
			-0.35988295,
			-0.3484065,
			-0.33687758,
			-0.32529795,
			-0.3136693,
			-0.30199343,
			-0.2902721,
			-0.278507,
			-0.2667,
			-0.25485283,
			-0.24296726,
			-0.23104513,
			-0.21908818,
			-0.20709825,
			-0.19507714,
			-0.18302663,
			-0.17094857,
			-0.15884475,
			-0.14671703,
			-0.1345672,
			-0.122397125,
			-0.1102086,
			-0.098003484,
			-0.08578361,
			-0.07355081,
			-0.061306935,
			-0.049053825,
			-0.036793333,
			-0.024527298,
			-0.01225757,
		};
		return sineTable[static_cast<std::uint32_t>(a_value) & 511];
	}

	inline float NiCosQImpl(float a_value)
	{
		static constexpr std::array<float, 512> cosineTable = {
			1,
			0.99992466,
			0.9996988,
			0.99932235,
			0.9987955,
			0.9981181,
			0.9972905,
			0.9963126,
			0.9951848,
			0.9939069,
			0.99247956,
			0.9909026,
			0.9891765,
			0.9873014,
			0.98527765,
			0.98310554,
			0.98078525,
			0.9783174,
			0.97570217,
			0.97293997,
			0.97003126,
			0.9669765,
			0.96377605,
			0.9604305,
			0.95694035,
			0.953306,
			0.94952816,
			0.9456073,
			0.941544,
			0.93733895,
			0.93299276,
			0.928506,
			0.9238795,
			0.9191138,
			0.9142097,
			0.90916795,
			0.9039892,
			0.89867437,
			0.8932243,
			0.8876396,
			0.8819212,
			0.87607,
			0.8700869,
			0.8639727,
			0.8577286,
			0.85135514,
			0.8448535,
			0.83822477,
			0.83146966,
			0.8245894,
			0.8175848,
			0.8104572,
			0.80320764,
			0.79583704,
			0.7883465,
			0.78073746,
			0.7730107,
			0.7651675,
			0.757209,
			0.74913657,
			0.7409514,
			0.7326545,
			0.72424734,
			0.7157312,
			0.7071071,
			0.6983766,
			0.68954086,
			0.6806013,
			0.6715594,
			0.6624162,
			0.65317327,
			0.6438321,
			0.6343938,
			0.62486,
			0.6152321,
			0.60551155,
			0.59569997,
			0.5857985,
			0.57580876,
			0.5657326,
			0.55557096,
			0.5453257,
			0.5349983,
			0.5245904,
			0.5141034,
			0.503539,
			0.4928988,
			0.48218435,
			0.47139725,
			0.4605392,
			0.44961178,
			0.43861666,
			0.4275555,
			0.41642994,
			0.40524167,
			0.39399236,
			0.38268372,
			0.37131745,
			0.35989526,
			0.34841886,
			0.33689,
			0.3253104,
			0.31368184,
			0.302006,
			0.2902847,
			0.2785197,
			0.26671273,
			0.2548656,
			0.24298008,
			0.23105797,
			0.21910107,
			0.20711116,
			0.19509009,
			0.1830396,
			0.17096157,
			0.1588578,
			0.1467301,
			0.13458028,
			0.12241022,
			0.11022172,
			0.09801662,
			0.08579675,
			0.07356397,
			0.06132011,
			0.049067013,
			0.036806528,
			0.024540495,
			0.01227077,
			-8.026785e-07,
			-0.012272376,
			-0.0245421,
			-0.03680813,
			-0.049068615,
			-0.06132171,
			-0.07356557,
			-0.08579836,
			-0.09801822,
			-0.110223316,
			-0.12241182,
			-0.13458188,
			-0.14673169,
			-0.15885939,
			-0.17096317,
			-0.18304119,
			-0.19509166,
			-0.20711274,
			-0.21910264,
			-0.23105954,
			-0.24298164,
			-0.25486714,
			-0.26671427,
			-0.27852124,
			-0.29028624,
			-0.30200756,
			-0.31368336,
			-0.32531196,
			-0.33689153,
			-0.34842038,
			-0.35989678,
			-0.37131894,
			-0.3826852,
			-0.39399382,
			-0.40524313,
			-0.4164314,
			-0.42755696,
			-0.43861812,
			-0.44961324,
			-0.46054062,
			-0.47139868,
			-0.4821857,
			-0.49290013,
			-0.50354034,
			-0.5141047,
			-0.5245917,
			-0.5349996,
			-0.545327,
			-0.5555723,
			-0.56573385,
			-0.57581025,
			-0.58579993,
			-0.5957014,
			-0.60551316,
			-0.6152337,
			-0.6248616,
			-0.6343954,
			-0.64383364,
			-0.65317494,
			-0.6624179,
			-0.67156106,
			-0.68060315,
			-0.68954265,
			-0.6983784,
			-0.7071089,
			-0.71573293,
			-0.7242492,
			-0.73265636,
			-0.74095327,
			-0.7491385,
			-0.75721097,
			-0.7651694,
			-0.7730125,
			-0.7807393,
			-0.7883485,
			-0.79583895,
			-0.80320954,
			-0.8104592,
			-0.81758684,
			-0.8245913,
			-0.83147156,
			-0.8382267,
			-0.84485555,
			-0.85135716,
			-0.85773057,
			-0.86397475,
			-0.8700889,
			-0.876072,
			-0.8819231,
			-0.88764143,
			-0.8932261,
			-0.8986762,
			-0.90399104,
			-0.9091697,
			-0.91421145,
			-0.91911554,
			-0.9238812,
			-0.9285077,
			-0.93299437,
			-0.9373405,
			-0.94154555,
			-0.94560874,
			-0.9495295,
			-0.9533074,
			-0.9569416,
			-0.9604318,
			-0.9637773,
			-0.9669777,
			-0.97003233,
			-0.97294104,
			-0.9757031,
			-0.9783184,
			-0.9807862,
			-0.9831064,
			-0.9852785,
			-0.9873022,
			-0.9891772,
			-0.99090326,
			-0.99248016,
			-0.9939076,
			-0.99518526,
			-0.996313,
			-0.99729085,
			-0.99811846,
			-0.9987957,
			-0.9993226,
			-0.99969894,
			-0.9999247,
			-1,
			-0.99992466,
			-0.9996987,
			-0.9993222,
			-0.9987952,
			-0.9981178,
			-0.99729013,
			-0.99631214,
			-0.9951842,
			-0.9939064,
			-0.9924789,
			-0.9909018,
			-0.9891757,
			-0.9873005,
			-0.9852767,
			-0.98310447,
			-0.9807842,
			-0.9783162,
			-0.97570086,
			-0.9729386,
			-0.97002983,
			-0.966975,
			-0.96377444,
			-0.96042883,
			-0.9569386,
			-0.95330423,
			-0.9495263,
			-0.9456054,
			-0.941542,
			-0.9373369,
			-0.93299055,
			-0.92850375,
			-0.9238771,
			-0.9191114,
			-0.9142072,
			-0.9091653,
			-0.9039866,
			-0.8986716,
			-0.8932214,
			-0.8876366,
			-0.8819182,
			-0.8760669,
			-0.8700837,
			-0.86396945,
			-0.85772514,
			-0.8513516,
			-0.84484994,
			-0.83822095,
			-0.8314657,
			-0.8245854,
			-0.8175808,
			-0.81045306,
			-0.80320334,
			-0.7958326,
			-0.788342,
			-0.78073275,
			-0.7730059,
			-0.7651626,
			-0.7572041,
			-0.74913156,
			-0.7409462,
			-0.73264927,
			-0.724242,
			-0.7157256,
			-0.70710146,
			-0.6983709,
			-0.6895351,
			-0.68059546,
			-0.6715533,
			-0.66241,
			-0.653167,
			-0.64382565,
			-0.63438725,
			-0.6248534,
			-0.61522543,
			-0.6055048,
			-0.59569293,
			-0.5857914,
			-0.5758017,
			-0.5657252,
			-0.55556357,
			-0.54531825,
			-0.5349908,
			-0.52458274,
			-0.5140957,
			-0.5035313,
			-0.492891,
			-0.4821765,
			-0.4713894,
			-0.4605313,
			-0.44960383,
			-0.43860868,
			-0.42754745,
			-0.41642183,
			-0.4052335,
			-0.39398417,
			-0.3826755,
			-0.3713092,
			-0.35988694,
			-0.34841052,
			-0.33688164,
			-0.325302,
			-0.31367338,
			-0.3019975,
			-0.29027617,
			-0.27851114,
			-0.26670414,
			-0.25485697,
			-0.24297144,
			-0.2310493,
			-0.21909237,
			-0.20710245,
			-0.19508134,
			-0.18303084,
			-0.1709528,
			-0.158849,
			-0.14672127,
			-0.13457146,
			-0.12240139,
			-0.11021287,
			-0.09800775,
			-0.085787885,
			-0.07355509,
			-0.061311215,
			-0.049058113,
			-0.03679762,
			-0.02453159,
			-0.012261862,
			9.711589e-06,
			0.012281284,
			0.024551008,
			0.036817033,
			0.049077515,
			0.061330605,
			0.07357445,
			0.08580723,
			0.09802708,
			0.11023217,
			0.12242065,
			0.13459072,
			0.1467405,
			0.15886818,
			0.17097194,
			0.18304995,
			0.1951004,
			0.20712146,
			0.21911134,
			0.23106821,
			0.24299029,
			0.25487575,
			0.26672286,
			0.2785298,
			0.29029477,
			0.30201605,
			0.31369182,
			0.32532036,
			0.3368999,
			0.34842873,
			0.35990506,
			0.37132722,
			0.38269344,
			0.39400202,
			0.4052513,
			0.4164395,
			0.427565,
			0.43862614,
			0.4496212,
			0.46054855,
			0.47140655,
			0.48219353,
			0.4929079,
			0.5035481,
			0.5141124,
			0.5245993,
			0.5350072,
			0.5453345,
			0.5555797,
			0.56574124,
			0.5758176,
			0.5858072,
			0.59570855,
			0.60552025,
			0.61524075,
			0.6248686,
			0.6344023,
			0.6438405,
			0.65318173,
			0.6624246,
			0.6715677,
			0.6806097,
			0.68954915,
			0.69838476,
			0.70711523,
			0.7157392,
			0.7242554,
			0.73266244,
			0.7409592,
			0.74914443,
			0.7572168,
			0.7651751,
			0.77301824,
			0.7807449,
			0.788354,
			0.7958444,
			0.8032149,
			0.8104645,
			0.81759197,
			0.82459635,
			0.83147657,
			0.83823156,
			0.84486026,
			0.85136175,
			0.8577351,
			0.8639792,
			0.8700932,
			0.8760762,
			0.88192725,
			0.8876455,
			0.8932301,
			0.8986801,
			0.9039948,
			0.90917337,
			0.91421497,
			0.919119,
			0.9238845,
			0.9285109,
			0.9329975,
			0.9373436,
			0.94154847,
			0.9456116,
			0.94953233,
			0.95331,
			0.9569442,
			0.96043426,
			0.9637797,
			0.96697986,
			0.97003454,
			0.97294307,
			0.97570515,
			0.9783202,
			0.980788,
			0.983108,
			0.98528004,
			0.9873036,
			0.98917854,
			0.9909045,
			0.99248123,
			0.9939085,
			0.9951861,
			0.9963138,
			0.9972915,
			0.99811894,
			0.9987961,
			0.99932295,
			0.9996992,
			0.9999249,
		};
		return cosineTable[static_cast<std::uint32_t>(a_value) & 511];
	}

	inline float NiSinQ(float a_radians)
	{
		return NiSinQImpl((512.0f / RE::NI_TWO_PI) * a_radians);
	}

	inline float NiCosQ(float a_radians)
	{
		return NiCosQImpl((512.0f / RE::NI_TWO_PI) * a_radians);
	}
}
